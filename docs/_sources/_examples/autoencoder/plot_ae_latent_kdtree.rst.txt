
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples/autoencoder/plot_ae_latent_kdtree.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_autoencoder_plot_ae_latent_kdtree.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_autoencoder_plot_ae_latent_kdtree.py:


KDTree for fast retrieval of nearest neighbours
===============================================

Model: Simple auto-encoder.

.. todo:: Document example

.. GENERATED FROM PYTHON SOURCE LINES 10-99

.. code-block:: default
   :lineno-start: 11


    import os
    import pandas as pd
    import numpy as np
    import pickle
    from torch.utils.data import DataLoader
    from sklearn.model_selection import train_test_split
    from sklearn import preprocessing
    from sklearn.neighbors import KDTree
    import matplotlib.pyplot as plt
    from matplotlib.colors import ListedColormap
    from tableone import TableOne

    from pkgname.core.AE.vae import get_device, set_seed
    from pkgname.utils.data_loader import load_dengue, IQR_rule
    from pkgname.utils.plot_utils import plotBox, formatTable
    from pkgname.utils.log_utils import Logger
    from definitions import ROOT_DIR

    logger = Logger('KDTree_VAE_Dengue', enable=True)

    SEED = 0
    batch_size = 16
    MODEL_PATH = os.path.join(ROOT_DIR, 'examples', 'autoencoder', 'model')
    LEAF_SIZE = 40


    # Set seed
    set_seed(SEED)

    # Get device
    device = get_device(False)

    features = ["dsource","date", "age", "gender", "weight", "bleeding", "plt",
                "shock", "haematocrit_percent", "bleeding_gum", "abdominal_pain",
                "ascites", "bleeding_mucosal", "bleeding_skin", "body_temperature"]

    df = load_dengue(usecols=['study_no']+features)

    for feat in features:
        df[feat] = df.groupby('study_no')[feat].ffill().bfill()

    df = df.loc[df['age'] <= 18]
    df = df.dropna()

    df = df.groupby(by="study_no", dropna=False).agg(
        dsource=pd.NamedAgg(column="dsource", aggfunc="last"),
        date=pd.NamedAgg(column="date", aggfunc="last"),
        age=pd.NamedAgg(column="age", aggfunc="max"),
        gender=pd.NamedAgg(column="gender", aggfunc="first"),
        weight=pd.NamedAgg(column="weight", aggfunc=np.mean),
        bleeding=pd.NamedAgg(column="bleeding", aggfunc="max"),
        plt=pd.NamedAgg(column="plt", aggfunc="min"),
        shock=pd.NamedAgg(column="shock", aggfunc="max"),
        haematocrit_percent=pd.NamedAgg(column="haematocrit_percent", aggfunc="max"),
        bleeding_gum=pd.NamedAgg(column="bleeding_gum", aggfunc="max"),
        abdominal_pain=pd.NamedAgg(column="abdominal_pain", aggfunc="max"),
        ascites=pd.NamedAgg(column="ascites", aggfunc="max"),
        bleeding_mucosal=pd.NamedAgg(column="bleeding_mucosal", aggfunc="max"),
        bleeding_skin=pd.NamedAgg(column="bleeding_skin", aggfunc="max"),
        body_temperature=pd.NamedAgg(column="body_temperature", aggfunc=np.mean),
    ).dropna()

    df = IQR_rule(df, ['plt'])

    mapping = {'Female': 0, 'Male': 1}
    df = df.replace({'gender': mapping})

    info_feat = ["dsource", "shock", "bleeding", "bleeding_gum", "abdominal_pain", "ascites",
               "bleeding_mucosal", "bleeding_skin", "gender"]
    data_feat = ["age", "weight", "plt", "haematocrit_percent", "body_temperature"]


    train, test = train_test_split(df, test_size=0.2, random_state=SEED)

    train_data = train[data_feat]
    test_data = test[data_feat]
    train_info = train[info_feat]
    test_info = test[info_feat]

    scaler = preprocessing.MinMaxScaler().fit(train_data)

    train_scaled = scaler.transform(train_data.to_numpy())
    test_scaled = scaler.transform(test_data.to_numpy())

    loader_train = DataLoader(train_scaled, batch_size, shuffle=True)
    loader_test = DataLoader(test_scaled, batch_size, shuffle=False)






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Using cpu




.. GENERATED FROM PYTHON SOURCE LINES 100-103

Encode test inputs
------------------


.. GENERATED FROM PYTHON SOURCE LINES 103-112

.. code-block:: default
   :lineno-start: 105



    model = pickle.load(open(MODEL_PATH, 'rb'))
    encoded_test = model.encode_inputs(loader_test)
    plt.scatter(encoded_test[:, 0], encoded_test[:, 1])
    plt.title("Encoded testset")
    logger.add_plt(plt.gcf())
    plt.show()




.. image:: /_examples/autoencoder/images/sphx_glr_plot_ae_latent_kdtree_001.png
    :alt: Encoded testset
    :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 113-116

KDTree
------
Highlighted: k points closest to selected point.

.. GENERATED FROM PYTHON SOURCE LINES 116-129

.. code-block:: default
   :lineno-start: 118



    tree = KDTree(encoded_test, leaf_size=LEAF_SIZE)
    idx = tree.query(encoded_test[:1], k=100, return_distance=False)

    c = [1 if (i in idx) else 0 for i in range(len(encoded_test))]

    plt.scatter(encoded_test[:, 0], encoded_test[:, 1], c=c)
    plt.title("Encoded testset")
    logger.add_plt(plt.gcf())
    plt.show()





.. image:: /_examples/autoencoder/images/sphx_glr_plot_ae_latent_kdtree_002.png
    :alt: Encoded testset
    :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 131-154

.. code-block:: default
   :lineno-start: 132


    # Table

    mapping = {0: 'Female', 1: 'Male'}
    table_df = test.replace({'gender': mapping})

    table_df['cluster'] = c

    columns = info_feat+data_feat
    nonnormal = list(table_df[columns].select_dtypes(include='number').columns)
    categorical = list(set(columns).difference(set(nonnormal)))
    columns = sorted(categorical) + sorted(nonnormal)

    rename = {'haematocrit_percent': 'hct',
              'body_temperature': 'temperature'}

    table = TableOne(table_df, columns=columns, categorical=categorical, nonnormal=nonnormal,
                     groupby='cluster', rename=rename, missing=False)

    html = formatTable(table, ["red", "blue"], ["Not selected", "Selected"])
    logger.append_html(html.render())
    html






.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <style  type="text/css" >
        #T_67960_ th.col_heading {
              font-size: 130%;
              text-align: right;
        }</style><table id="T_67960_" ><thead>    <tr>        <th class="blank" ></th>        <th class="blank level0" ></th>        <th class="col_heading level0 col0" >Overall</th>        <th class="col_heading level0 col1" >Not selected</th>        <th class="col_heading level0 col2" >Selected</th>    </tr></thead><tbody>
                    <tr>
                            <th id="T_67960_level0_row0" class="row_heading level0 row0" >n</th>
                            <th id="T_67960_level1_row0" class="row_heading level1 row0" ></th>
                            <td id="T_67960_row0_col0" class="data row0 col0" >2897</td>
                            <td id="T_67960_row0_col1" class="data row0 col1" >2797</td>
                            <td id="T_67960_row0_col2" class="data row0 col2" >100</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row1" class="row_heading level0 row1" rowspan="2">abdominal_pain, n (%)</th>
                            <th id="T_67960_level1_row1" class="row_heading level1 row1" >False</th>
                            <td id="T_67960_row1_col0" class="data row1 col0" >1968 (67.9)</td>
                            <td id="T_67960_row1_col1" class="data row1 col1" >1913 (68.4)</td>
                            <td id="T_67960_row1_col2" class="data row1 col2" >55 (55.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row2" class="row_heading level1 row2" >True</th>
                            <td id="T_67960_row2_col0" class="data row2 col0" >929 (32.1)</td>
                            <td id="T_67960_row2_col1" class="data row2 col1" >884 (31.6)</td>
                            <td id="T_67960_row2_col2" class="data row2 col2" >45 (45.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row3" class="row_heading level0 row3" rowspan="2">ascites, n (%)</th>
                            <th id="T_67960_level1_row3" class="row_heading level1 row3" >False</th>
                            <td id="T_67960_row3_col0" class="data row3 col0" >2437 (84.1)</td>
                            <td id="T_67960_row3_col1" class="data row3 col1" >2349 (84.0)</td>
                            <td id="T_67960_row3_col2" class="data row3 col2" >88 (88.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row4" class="row_heading level1 row4" >True</th>
                            <td id="T_67960_row4_col0" class="data row4 col0" >460 (15.9)</td>
                            <td id="T_67960_row4_col1" class="data row4 col1" >448 (16.0)</td>
                            <td id="T_67960_row4_col2" class="data row4 col2" >12 (12.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row5" class="row_heading level0 row5" rowspan="2">bleeding, n (%)</th>
                            <th id="T_67960_level1_row5" class="row_heading level1 row5" >False</th>
                            <td id="T_67960_row5_col0" class="data row5 col0" >2160 (74.6)</td>
                            <td id="T_67960_row5_col1" class="data row5 col1" >2108 (75.4)</td>
                            <td id="T_67960_row5_col2" class="data row5 col2" >52 (52.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row6" class="row_heading level1 row6" >True</th>
                            <td id="T_67960_row6_col0" class="data row6 col0" >737 (25.4)</td>
                            <td id="T_67960_row6_col1" class="data row6 col1" >689 (24.6)</td>
                            <td id="T_67960_row6_col2" class="data row6 col2" >48 (48.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row7" class="row_heading level0 row7" rowspan="2">bleeding_gum, n (%)</th>
                            <th id="T_67960_level1_row7" class="row_heading level1 row7" >False</th>
                            <td id="T_67960_row7_col0" class="data row7 col0" >2585 (89.2)</td>
                            <td id="T_67960_row7_col1" class="data row7 col1" >2490 (89.0)</td>
                            <td id="T_67960_row7_col2" class="data row7 col2" >95 (95.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row8" class="row_heading level1 row8" >True</th>
                            <td id="T_67960_row8_col0" class="data row8 col0" >312 (10.8)</td>
                            <td id="T_67960_row8_col1" class="data row8 col1" >307 (11.0)</td>
                            <td id="T_67960_row8_col2" class="data row8 col2" >5 (5.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row9" class="row_heading level0 row9" rowspan="2">bleeding_mucosal, n (%)</th>
                            <th id="T_67960_level1_row9" class="row_heading level1 row9" >False</th>
                            <td id="T_67960_row9_col0" class="data row9 col0" >2359 (81.4)</td>
                            <td id="T_67960_row9_col1" class="data row9 col1" >2293 (82.0)</td>
                            <td id="T_67960_row9_col2" class="data row9 col2" >66 (66.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row10" class="row_heading level1 row10" >True</th>
                            <td id="T_67960_row10_col0" class="data row10 col0" >538 (18.6)</td>
                            <td id="T_67960_row10_col1" class="data row10 col1" >504 (18.0)</td>
                            <td id="T_67960_row10_col2" class="data row10 col2" >34 (34.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row11" class="row_heading level0 row11" rowspan="2">bleeding_skin, n (%)</th>
                            <th id="T_67960_level1_row11" class="row_heading level1 row11" >False</th>
                            <td id="T_67960_row11_col0" class="data row11 col0" >1594 (55.0)</td>
                            <td id="T_67960_row11_col1" class="data row11 col1" >1584 (56.6)</td>
                            <td id="T_67960_row11_col2" class="data row11 col2" >10 (10.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row12" class="row_heading level1 row12" >True</th>
                            <td id="T_67960_row12_col0" class="data row12 col0" >1303 (45.0)</td>
                            <td id="T_67960_row12_col1" class="data row12 col1" >1213 (43.4)</td>
                            <td id="T_67960_row12_col2" class="data row12 col2" >90 (90.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row13" class="row_heading level0 row13" rowspan="10">dsource, n (%)</th>
                            <th id="T_67960_level1_row13" class="row_heading level1 row13" >01nva</th>
                            <td id="T_67960_row13_col0" class="data row13 col0" >11 (0.4)</td>
                            <td id="T_67960_row13_col1" class="data row13 col1" >9 (0.3)</td>
                            <td id="T_67960_row13_col2" class="data row13 col2" >2 (2.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row14" class="row_heading level1 row14" >06dx</th>
                            <td id="T_67960_row14_col0" class="data row14 col0" >63 (2.2)</td>
                            <td id="T_67960_row14_col1" class="data row14 col1" >59 (2.1)</td>
                            <td id="T_67960_row14_col2" class="data row14 col2" >4 (4.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row15" class="row_heading level1 row15" >13dx</th>
                            <td id="T_67960_row15_col0" class="data row15 col0" >1619 (55.9)</td>
                            <td id="T_67960_row15_col1" class="data row15 col1" >1612 (57.6)</td>
                            <td id="T_67960_row15_col2" class="data row15 col2" >7 (7.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row16" class="row_heading level1 row16" >32dx</th>
                            <td id="T_67960_row16_col0" class="data row16 col0" >1 (0.0)</td>
                            <td id="T_67960_row16_col1" class="data row16 col1" >1 (0.0)</td>
                            <td id="T_67960_row16_col2" class="data row16 col2" ></td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row17" class="row_heading level1 row17" >42dx</th>
                            <td id="T_67960_row17_col0" class="data row17 col0" >4 (0.1)</td>
                            <td id="T_67960_row17_col1" class="data row17 col1" >4 (0.1)</td>
                            <td id="T_67960_row17_col2" class="data row17 col2" ></td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row18" class="row_heading level1 row18" >d001</th>
                            <td id="T_67960_row18_col0" class="data row18 col0" >8 (0.3)</td>
                            <td id="T_67960_row18_col1" class="data row18 col1" >8 (0.3)</td>
                            <td id="T_67960_row18_col2" class="data row18 col2" ></td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row19" class="row_heading level1 row19" >df</th>
                            <td id="T_67960_row19_col0" class="data row19 col0" >366 (12.6)</td>
                            <td id="T_67960_row19_col1" class="data row19 col1" >340 (12.2)</td>
                            <td id="T_67960_row19_col2" class="data row19 col2" >26 (26.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row20" class="row_heading level1 row20" >dr</th>
                            <td id="T_67960_row20_col0" class="data row20 col0" >302 (10.4)</td>
                            <td id="T_67960_row20_col1" class="data row20 col1" >296 (10.6)</td>
                            <td id="T_67960_row20_col2" class="data row20 col2" >6 (6.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row21" class="row_heading level1 row21" >fl</th>
                            <td id="T_67960_row21_col0" class="data row21 col0" >34 (1.2)</td>
                            <td id="T_67960_row21_col1" class="data row21 col1" >28 (1.0)</td>
                            <td id="T_67960_row21_col2" class="data row21 col2" >6 (6.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row22" class="row_heading level1 row22" >md</th>
                            <td id="T_67960_row22_col0" class="data row22 col0" >489 (16.9)</td>
                            <td id="T_67960_row22_col1" class="data row22 col1" >440 (15.7)</td>
                            <td id="T_67960_row22_col2" class="data row22 col2" >49 (49.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row23" class="row_heading level0 row23" rowspan="2">gender, n (%)</th>
                            <th id="T_67960_level1_row23" class="row_heading level1 row23" >Female</th>
                            <td id="T_67960_row23_col0" class="data row23 col0" >1281 (44.2)</td>
                            <td id="T_67960_row23_col1" class="data row23 col1" >1246 (44.5)</td>
                            <td id="T_67960_row23_col2" class="data row23 col2" >35 (35.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row24" class="row_heading level1 row24" >Male</th>
                            <td id="T_67960_row24_col0" class="data row24 col0" >1616 (55.8)</td>
                            <td id="T_67960_row24_col1" class="data row24 col1" >1551 (55.5)</td>
                            <td id="T_67960_row24_col2" class="data row24 col2" >65 (65.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row25" class="row_heading level0 row25" rowspan="2">shock, n (%)</th>
                            <th id="T_67960_level1_row25" class="row_heading level1 row25" >False</th>
                            <td id="T_67960_row25_col0" class="data row25 col0" >2761 (95.3)</td>
                            <td id="T_67960_row25_col1" class="data row25 col1" >2682 (95.9)</td>
                            <td id="T_67960_row25_col2" class="data row25 col2" >79 (79.0)</td>
                </tr>
                <tr>
                                    <th id="T_67960_level1_row26" class="row_heading level1 row26" >True</th>
                            <td id="T_67960_row26_col0" class="data row26 col0" >136 (4.7)</td>
                            <td id="T_67960_row26_col1" class="data row26 col1" >115 (4.1)</td>
                            <td id="T_67960_row26_col2" class="data row26 col2" >21 (21.0)</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row27" class="row_heading level0 row27" >age, median [Q1,Q3]</th>
                            <th id="T_67960_level1_row27" class="row_heading level1 row27" ></th>
                            <td id="T_67960_row27_col0" class="data row27 col0" >8.0 [5.0,11.0]</td>
                            <td id="T_67960_row27_col1" class="data row27 col1" >8.0 [5.0,11.0]</td>
                            <td id="T_67960_row27_col2" class="data row27 col2" >13.0 [13.0,14.0]</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row28" class="row_heading level0 row28" >temperature, median [Q1,Q3]</th>
                            <th id="T_67960_level1_row28" class="row_heading level1 row28" ></th>
                            <td id="T_67960_row28_col0" class="data row28 col0" >37.6 [37.2,38.3]</td>
                            <td id="T_67960_row28_col1" class="data row28 col1" >37.6 [37.2,38.3]</td>
                            <td id="T_67960_row28_col2" class="data row28 col2" >38.4 [37.3,39.0]</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row29" class="row_heading level0 row29" >hct, median [Q1,Q3]</th>
                            <th id="T_67960_level1_row29" class="row_heading level1 row29" ></th>
                            <td id="T_67960_row29_col0" class="data row29 col0" >40.1 [37.2,44.8]</td>
                            <td id="T_67960_row29_col1" class="data row29 col1" >40.0 [37.1,44.0]</td>
                            <td id="T_67960_row29_col2" class="data row29 col2" >49.0 [47.4,50.8]</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row30" class="row_heading level0 row30" >plt, median [Q1,Q3]</th>
                            <th id="T_67960_level1_row30" class="row_heading level1 row30" ></th>
                            <td id="T_67960_row30_col0" class="data row30 col0" >169.0 [71.0,240.0]</td>
                            <td id="T_67960_row30_col1" class="data row30 col1" >175.0 [77.8,243.0]</td>
                            <td id="T_67960_row30_col2" class="data row30 col2" >35.7 [22.8,55.0]</td>
                </tr>
                <tr>
                            <th id="T_67960_level0_row31" class="row_heading level0 row31" >weight, median [Q1,Q3]</th>
                            <th id="T_67960_level1_row31" class="row_heading level1 row31" ></th>
                            <td id="T_67960_row31_col0" class="data row31 col0" >26.0 [18.5,37.0]</td>
                            <td id="T_67960_row31_col1" class="data row31 col1" >25.0 [18.0,36.0]</td>
                            <td id="T_67960_row31_col2" class="data row31 col2" >41.0 [36.0,46.0]</td>
                </tr>
        </tbody></table>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 155-157

Logging
-------

.. GENERATED FROM PYTHON SOURCE LINES 157-172

.. code-block:: default
   :lineno-start: 158


    # Log parameters
    logger.save_parameters(
        {
            'SEED': SEED,
            'model_path': MODEL_PATH,
            'leaf_size': LEAF_SIZE,
            'device': str(device),
            'batch_size': batch_size,
            'features': features,
            'info_feat': info_feat,
            'data_feat': data_feat
        }
    )

    logger.create_report()







.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  2.944 seconds)


.. _sphx_glr_download__examples_autoencoder_plot_ae_latent_kdtree.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_ae_latent_kdtree.py <plot_ae_latent_kdtree.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_ae_latent_kdtree.ipynb <plot_ae_latent_kdtree.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
