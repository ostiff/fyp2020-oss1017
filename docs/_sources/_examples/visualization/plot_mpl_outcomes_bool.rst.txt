
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples/visualization/plot_mpl_outcomes_bool.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_visualization_plot_mpl_outcomes_bool.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_visualization_plot_mpl_outcomes_bool.py:


Outcomes (boolean)
==================

This script is useful to understand the distribution
over the 2D projected space of the different outcomes.
For that purpose, first patients are grouped to their
worst case scenario (highest HCT and lowest PLT). Then
the number of patients with certain outcome in the 2D
space is calculate (histogram) and plotted.

.. GENERATED FROM PYTHON SOURCE LINES 13-253

.. code-block:: default
   :lineno-start: 14


    # Library
    import pickle
    import pandas as pd
    import numpy as np
    import matplotlib as mpl

    # Specific
    from torch.utils.data import DataLoader
    from sklearn.preprocessing import MinMaxScaler

    # Specific
    from pkgname.core.AE.autoencoder import get_device, set_seed
    from pkgname.utils.data_loader import load_dengue, IQR_rule

    # Local
    import _utils



    # ------------------------------
    # Constants
    # ------------------------------
    # Load constants
    features = _utils.features
    others = _utils.others
    mappings = _utils.mappings
    aggregation = _utils.aggregation
    cmaps = _utils.cmaps

    # Define outcomes
    outcomes = [
        "severe",
        "warning",
        "mild",
        "shock",
        "severe_leak",
        "severe_bleed",
        "severe_organ",
        "overload",
        "ascites",
        "oedema",
        "effusion",
        "pleural_effusion",
        "jaundice",
        "liver_abnormal",
        "cns_abnormal",
        #"cerebro", #0
        "neurology",
        #"kidney_abnormal",#0
        "bleeding_gi",
        #"bleeding_urine", #0
        "bleeding_mucosal",
        "bleeding_skin",
        "bleeding_gum",
        "bleeding_nose",
        "respiratory_distress",
        "vomiting",
        "abdominal_pain",
        "abdominal_tenderness",
        "chest_indrawing",
        "event_death",
        "heart_sound_abnormal",
        #"inotrope", 0
        "lung",
        #"perfusion", #0
        "pericardial_effusion",
        "previous_dengue",
        #"renal_disease", #0
        #"xray_pleural_effusion", #0
        "restlessness",
        "lethargy",
        "alt>1000",
        "ast>1000",
        "liver>2"
    ]

    # Ensure all outcomes are in aggregation
    for c in outcomes:
        if c not in aggregation:
            print("Adding... %23s | max" % c)
            aggregation[c] = 'max'

    nrows, ncols = 5, 8

    # ------------------------------
    # Load data
    # ------------------------------
    # Load data
    data = _utils.load_data()

    # Conditions
    data['ast>1000'] = data.ast.fillna(0) >= 1000
    data['alt>1000'] = data.alt.fillna(0) >= 1000
    data['liver>2'] = data.liver_palpation_size.fillna(0) > 2

    # Liver abnormal
    data['liver_abnormal'] = \
        data.liver_acute | \
        data.liver_involved | \
        data.liver_failure | \
        data.liver_severe | \
        data.jaundice

    # Kidney abnormal
    data['kidney_abnormal'] = \
        data.skidney

    # Create features
    data['severe_leak'] = \
        data.ascites | \
        data.overload | \
        data.oedema_pulmonary | \
        data.respiratory_distress | \
        data.oedema | \
        data.pleural_effusion | \
        data.effusion

    # Bleeding
    data['severe_bleed'] = \
        data.bleeding_gi | \
        data.bleeding_urine # useless

    # Organ impairment
    data['severe_organ'] = \
        data.cns_abnormal | \
        data.neurology.astype(bool) | \
        data.liver_abnormal | \
        data.kidney_abnormal | \
        (data.ast.fillna(0) >= 1000) | \
        (data.alt.fillna(0) >= 1000)

    # Category: severe
    data['severe'] = \
        data.severe_leak | \
        data.severe_bleed | \
        data.severe_organ | \
        data.shock

    # Category: warning WHO
    data['warning'] = \
        data.abdominal_pain | \
        data.abdominal_tenderness | \
        data.vomiting | \
        data.ascites | \
        data.pleural_effusion | \
        data.bleeding_mucosal | \
        data.restlessness | \
        data.lethargy | \
        (data.liver_palpation_size.fillna(0) > 2)

    # Category: mild
    data['mild'] = ~(data.severe | data.warning)

    # .. note: We are assuming that these are all
    #          boolean features, usually containing
    #          1 when an unusual event happens. Thus
    #          filling with 0 (e.g. shock).
    # Fill empty values
    for c in outcomes:
        data[c] = data[c].fillna(0)

    # Filter data (age, iqr, ...)
    data = data[data.age.between(0.0, 18.0)]
    data = data[data.plt < 50000] # extreme outlier

    # Filter outliers
    data = IQR_rule(data, [
        'plt',
        #'haematocrit_percent',
        #'body_temperature'
    ])

    # Rename
    # .. note: Done after convert_dtypes so that
    #          it remains 0 or 1, otherwise it will
    #          be transformed to boolean feature.
    #          (its ok too).
    data = data.replace(mappings)

    # .. note: aggregating by patient so we have
    #          one single outcome per patient.
    # Get worst state for patient
    data = data.groupby(by="study_no", dropna=False) \
        .agg(aggregation).dropna()

    # Show data
    print("\nData:")
    print(data)
    print(data.dtypes)
    print(data.index.nunique())
    print(data[outcomes].sum().sort_values())


    # ------------------------------
    # Load Model
    # ------------------------------
    # Load model
    model = _utils.load_model()

    # Show
    print("\nModel:")
    print(model)

    # ------------------------------
    # Projections
    # ------------------------------
    # .. note: The scaling method should have also been
    #          saved when training the model.
    # Features
    datap = data[features].copy(deep=True)

    # Scale first
    datap = MinMaxScaler().fit_transform(datap)

    # Encode
    encoded = model.encode_inputs( \
        DataLoader(datap, 16, shuffle=False))

    # Include in original dataset
    data[['x', 'y']] = encoded

    # Show
    print("\nEncoded:")
    print(encoded)
    print("\nData:")
    print(data)


    # ------------------------------
    # Visualization
    # ------------------------------
    # Libraries
    import matplotlib.pyplot as plt

    # Specific
    from _utils import kde_mpl_plot
    from _utils import kde_mpl_compute
    from _utils import kde_mpl





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Adding...             severe_leak | max
    Adding...            severe_bleed | max
    Adding...            severe_organ | max
    Adding...                overload | max
    Adding...                 ascites | max
    Adding...                  oedema | max
    Adding...                effusion | max
    Adding...        pleural_effusion | max
    Adding...                jaundice | max
    Adding...          liver_abnormal | max
    Adding...            cns_abnormal | max
    Adding...               neurology | max
    Adding...             bleeding_gi | max
    Adding...        bleeding_mucosal | max
    Adding...           bleeding_skin | max
    Adding...            bleeding_gum | max
    Adding...           bleeding_nose | max
    Adding...    respiratory_distress | max
    Adding...                vomiting | max
    Adding...          abdominal_pain | max
    Adding...    abdominal_tenderness | max
    Adding...         chest_indrawing | max
    Adding...             event_death | max
    Adding...    heart_sound_abnormal | max
    Adding...                    lung | max
    Adding...    pericardial_effusion | max
    Adding...         previous_dengue | max
    Adding...            restlessness | max
    Adding...                lethargy | max
    Adding...                alt>1000 | max
    Adding...                ast>1000 | max
    Adding...                 liver>2 | max

    Data:
                   dsource   age  weight    plt  haematocrit_percent  body_temperature  gender       date  shock  ...  heart_sound_abnormal  lung  pericardial_effusion  previous_dengue  restlessness  lethargy alt>1000 ast>1000 liver>2
    study_no                                                                                                      ...                                                                                                                     
    01nva-003-2008   01nva  16.0    72.0    8.0        54.0000              37.0750        1.0 2020-07-17   True  ...              0            0              0                     0               0     False    False    False   False
    01nva-003-2009   01nva  17.0    44.0    8.0        47.3333              37.0000        0.0 2020-07-30   True  ...              0            0              0                     0               0     False    False    False   False
    01nva-003-2012   01nva  17.0    48.0    9.0        49.1500              37.1875        0.0 2020-08-15   True  ...              0            0              0                     0               0     False    False    False   False
    01nva-003-2024   01nva  16.0   114.0    9.0        49.1000              37.1167        1.0 2020-10-09   True  ...              0            0              0                     0               0     False    False    False   False
    01nva-003-2028   01nva  18.0    82.0   18.0        42.9714              37.1500        0.0 2020-11-07   True  ...              0            0              0                     0               0     False    False    False   False
    ...                ...   ...     ...    ...            ...                  ...        ...        ...    ...  ...            ...          ...            ...                   ...             ...       ...      ...      ...     ...
    md-994              md  13.0    53.0   88.0        42.0000              40.0000        0.0 2003-08-27  False  ...          False            0              0                     0               0         0    False    False   False
    md-995              md   9.0    27.5  132.0        37.8000              39.0000        0.0 2003-08-27  False  ...          False            0              0                     0               0         0    False    False   False
    md-996              md  10.0    33.0   75.0        43.0000              39.9000        0.0 2003-07-24  False  ...          False            0              0                     0               0         0    False    False   False
    md-998              md  13.0    44.0   94.0        41.5000              38.5000        1.0 2003-08-29  False  ...          False            0              0                     0               0         0    False    False   False
    md-999              md  15.0    49.0   56.0        40.5000              38.5000        0.0 2003-08-29  False  ...          False            0              0                     0               0         0    False    False   False

    [12884 rows x 44 columns]
    dsource                        object
    age                           float64
    weight                        float64
    plt                           float64
    haematocrit_percent           float64
    body_temperature              float64
    gender                        float64
    date                    datetime64...
    shock                          object
    severe                           bool
    warning                          bool
    mild                             bool
    severe_leak                      bool
    severe_bleed                     bool
    severe_organ                     bool
    overload                       object
    ascites                        object
    oedema                         object
    effusion                       object
    pleural_effusion               object
    jaundice                       object
    liver_abnormal                   bool
    cns_abnormal                   object
    neurology                     float64
    bleeding_gi                    object
    bleeding_mucosal               object
    bleeding_skin                  object
    bleeding_gum                   object
    bleeding_nose                  object
    respiratory_distress           object
    vomiting                       object
    abdominal_pain                 object
    abdominal_tenderness           object
    chest_indrawing                object
    event_death                    object
    heart_sound_abnormal           object
    lung                           object
    pericardial_effusion           object
    previous_dengue                object
    restlessness                   object
    lethargy                       object
    alt>1000                         bool
    ast>1000                         bool
    liver>2                          bool
    dtype: object
    12884
    pericardial_effusion        2
    jaundice                    3
    lethargy                    3
    alt>1000                    4
    liver_abnormal              5
    event_death                 6
    heart_sound_abnormal        9
    oedema                     12
    chest_indrawing            13
    ast>1000                   19
    effusion                   22
    previous_dengue            22
    respiratory_distress       46
    bleeding_nose              93
    ascites                   104
    pleural_effusion          112
    bleeding_gum              114
    severe_bleed              128
    bleeding_gi               128
    neurology               212.0
    lung                      212
    restlessness              293
    liver>2                   382
    overload                  490
    shock                     569
    severe_leak               635
    bleeding_mucosal          656
    abdominal_tenderness     1587
    cns_abnormal             1836
    bleeding_skin            2715
    abdominal_pain           3048
    severe_organ             4697
    severe                   4860
    vomiting                 5384
    mild                     5609
    warning                  6809
    dtype: object

    Model:
    Autoencoder(
      (encoder): Sequential(
        (0): Linear(in_features=5, out_features=3, bias=True)
        (1): Sigmoid()
        (2): Linear(in_features=3, out_features=2, bias=True)
        (3): Sigmoid()
      )
      (decoder): Sequential(
        (0): Linear(in_features=2, out_features=3, bias=True)
        (1): Sigmoid()
        (2): Linear(in_features=3, out_features=5, bias=True)
        (3): Sigmoid()
      )
    )

    Encoded:
    [[0.1520529  0.74539393]
     [0.2646528  0.7333292 ]
     [0.23637003 0.7385248 ]
     ...
     [0.453338   0.620019  ]
     [0.28497958 0.5708288 ]
     [0.23240355 0.62076086]]

    Data:
                   dsource   age  weight    plt  haematocrit_percent  body_temperature  gender       date  shock  severe  ...  lung  pericardial_effusion  previous_dengue  restlessness  lethargy alt>1000 ast>1000 liver>2       x       y
    study_no                                                                                                              ...                                                                                                               
    01nva-003-2008   01nva  16.0    72.0    8.0        54.0000              37.0750        1.0 2020-07-17   True    True  ...     0              0                     0               0     False    False    False   False  0.1521  0.7454
    01nva-003-2009   01nva  17.0    44.0    8.0        47.3333              37.0000        0.0 2020-07-30   True    True  ...     0              0                     0               0     False    False    False   False  0.2647  0.7333
    01nva-003-2012   01nva  17.0    48.0    9.0        49.1500              37.1875        0.0 2020-08-15   True    True  ...     0              0                     0               0     False    False    False   False  0.2364  0.7385
    01nva-003-2024   01nva  16.0   114.0    9.0        49.1000              37.1167        1.0 2020-10-09   True    True  ...     0              0                     0               0     False    False    False   False  0.0784  0.7186
    01nva-003-2028   01nva  18.0    82.0   18.0        42.9714              37.1500        0.0 2020-11-07   True    True  ...     0              0                     0               0     False    False    False   False  0.1081  0.6866
    ...                ...   ...     ...    ...            ...                  ...        ...        ...    ...     ...  ...   ...            ...                   ...             ...       ...      ...      ...     ...     ...     ...
    md-994              md  13.0    53.0   88.0        42.0000              40.0000        0.0 2003-08-27  False    True  ...     0              0                     0               0         0    False    False   False  0.2172  0.5767
    md-995              md   9.0    27.5  132.0        37.8000              39.0000        0.0 2003-08-27  False    True  ...     0              0                     0               0         0    False    False   False  0.4946  0.5147
    md-996              md  10.0    33.0   75.0        43.0000              39.9000        0.0 2003-07-24  False    True  ...     0              0                     0               0         0    False    False   False  0.4533  0.6200
    md-998              md  13.0    44.0   94.0        41.5000              38.5000        1.0 2003-08-29  False    True  ...     0              0                     0               0         0    False    False   False  0.2850  0.5708
    md-999              md  15.0    49.0   56.0        40.5000              38.5000        0.0 2003-08-29  False    True  ...     0              0                     0               0         0    False    False   False  0.2324  0.6208

    [12884 rows x 46 columns]




.. GENERATED FROM PYTHON SOURCE LINES 254-256

Display using hexbin
--------------------

.. GENERATED FROM PYTHON SOURCE LINES 256-278

.. code-block:: default
   :lineno-start: 257


    # --------------------------------
    # Show interesting outcomes (hex)
    # --------------------------------
    # Figure with hexbins
    f3, axes3 = plt.subplots(nrows, ncols,
        figsize=(15, 8), sharex=True, sharey=True)

    # Loop
    for i, c in enumerate(outcomes):
        # Select dataset
        aux = data[data[c] == 1]
        # Plot hexbin
        axes3.flat[i].hexbin(aux.x, aux.y, label=c,
            gridsize=30, cmap=cmaps.get(c, 'Reds'))
        # Configure
        axes3.flat[i].set(aspect='equal',
            title='%s (%s)' % (c, aux.shape[0]))

    # Configure
    plt.tight_layout()




.. image:: /_examples/visualization/images/sphx_glr_plot_mpl_outcomes_bool_001.png
    :alt: severe (4860), warning (6809), mild (5609), shock (569), severe_leak (635), severe_bleed (128), severe_organ (4697), overload (490), ascites (104), oedema (12), effusion (22), pleural_effusion (112), jaundice (3), liver_abnormal (5), cns_abnormal (1836), neurology (212), bleeding_gi (128), bleeding_mucosal (656), bleeding_skin (2715), bleeding_gum (114), bleeding_nose (93), respiratory_distress (46), vomiting (5384), abdominal_pain (3048), abdominal_tenderness (1587), chest_indrawing (13), event_death (6), heart_sound_abnormal (9), lung (212), pericardial_effusion (2), previous_dengue (22), restlessness (293), lethargy (3), alt>1000 (4), ast>1000 (19), liver>2 (382)
    :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 279-281

Display using KDE
-----------------

.. GENERATED FROM PYTHON SOURCE LINES 281-305

.. code-block:: default
   :lineno-start: 282


    # --------------------------------
    # Show interesting outcomes (KDE)
    # --------------------------------
    # Figure with kdes
    f4, axes4 = plt.subplots(nrows, ncols,
        figsize=(15, 8), sharex=True, sharey=True)

    # Loop
    for i, c in enumerate(outcomes):
        # Select dataset
        aux = data[data[c] == 1]
        # Plot kde
        kde_mpl(aux.x, aux.y, ax=axes4.flat[i],
            contour=False, cmap=cmaps.get(c, 'Reds'),
            xlim=(data.x.min(), data.x.max()),
            ylim=(data.y.min(), data.y.max()))
        # Configure
        axes4.flat[i].set(aspect='equal',
            title='%s (%s)' % (c, aux.shape[0]))

    # Configure
    plt.tight_layout()




.. image:: /_examples/visualization/images/sphx_glr_plot_mpl_outcomes_bool_002.png
    :alt: severe (4860), warning (6809), mild (5609), shock (569), severe_leak (635), severe_bleed (128), severe_organ (4697), overload (490), ascites (104), oedema (12), effusion (22), pleural_effusion (112), jaundice (3), liver_abnormal (5), cns_abnormal (1836), neurology (212), bleeding_gi (128), bleeding_mucosal (656), bleeding_skin (2715), bleeding_gum (114), bleeding_nose (93), respiratory_distress (46), vomiting (5384), abdominal_pain (3048), abdominal_tenderness (1587), chest_indrawing (13), event_death (6), heart_sound_abnormal (9), lung (212), pericardial_effusion (2), previous_dengue (22), restlessness (293), lethargy (3), alt>1000 (4), ast>1000 (19), liver>2 (382)
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Exception! singular matrix




.. GENERATED FROM PYTHON SOURCE LINES 306-308

Display using contours
----------------------

.. GENERATED FROM PYTHON SOURCE LINES 308-333

.. code-block:: default
   :lineno-start: 309


    # ------------------------------------
    # Show interesting outcomes (contours)
    # ------------------------------------
    # Figure with kdes
    f5, axes5 = plt.subplots(nrows, ncols,
        figsize=(15, 8), sharex=True, sharey=True)

    # Loop
    for i, c in enumerate(outcomes):
        # Select dataset
        aux = data[data[c] == 1]
        # Plot kde
        kde_mpl(aux.x, aux.y, ax=axes5.flat[i],
            contour=True, cmap=cmaps.get(c, 'Reds'),
            xlim=(data.x.min(), data.x.max()),
            ylim=(data.y.min(), data.y.max()))
        # Configure
        axes5.flat[i].set(aspect='equal',
            title='%s (%s)' % (c, aux.shape[0]))

    # Configure
    plt.tight_layout()

    # Show
    plt.show()


.. image:: /_examples/visualization/images/sphx_glr_plot_mpl_outcomes_bool_003.png
    :alt: severe (4860), warning (6809), mild (5609), shock (569), severe_leak (635), severe_bleed (128), severe_organ (4697), overload (490), ascites (104), oedema (12), effusion (22), pleural_effusion (112), jaundice (3), liver_abnormal (5), cns_abnormal (1836), neurology (212), bleeding_gi (128), bleeding_mucosal (656), bleeding_skin (2715), bleeding_gum (114), bleeding_nose (93), respiratory_distress (46), vomiting (5384), abdominal_pain (3048), abdominal_tenderness (1587), chest_indrawing (13), event_death (6), heart_sound_abnormal (9), lung (212), pericardial_effusion (2), previous_dengue (22), restlessness (293), lethargy (3), alt>1000 (4), ast>1000 (19), liver>2 (382)
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Exception! singular matrix





.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  42.196 seconds)


.. _sphx_glr_download__examples_visualization_plot_mpl_outcomes_bool.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_mpl_outcomes_bool.py <plot_mpl_outcomes_bool.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_mpl_outcomes_bool.ipynb <plot_mpl_outcomes_bool.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
