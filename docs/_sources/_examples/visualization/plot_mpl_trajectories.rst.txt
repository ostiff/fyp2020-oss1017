
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "_examples/visualization/plot_mpl_trajectories.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download__examples_visualization_plot_mpl_trajectories.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr__examples_visualization_plot_mpl_trajectories.py:


Trajectories
============

.. GENERATED FROM PYTHON SOURCE LINES 5-454



.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_001.png
          :alt: Severe (5029), Warning (6809), Mild (5609)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_002.png
          :alt: Patient 1105 (28 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_003.png
          :alt: Patient 2012 (17 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_004.png
          :alt: Patient 2013 (20 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_005.png
          :alt: Patient 2026 (24 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_006.png
          :alt: Patient 2103 (29 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_007.png
          :alt: Patient 2104 (22 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_008.png
          :alt: Patient 2110 (17 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_009.png
          :alt: Patient 2168 (16 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_010.png
          :alt: Patient 2203 (10 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_011.png
          :alt: Patient 2205 (13 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_012.png
          :alt: Patient 2206 (12 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_013.png
          :alt: Patient 2205 (13 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_014.png
          :alt: Patient 2217 (14 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_015.png
          :alt: Patient 2222 (8 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_016.png
          :alt: Patient 2209 (10 years)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_017.png
          :alt: 2209 (84 yo), 2209 (39 yo), 2209 (30 yo), 2209 (40 yo), 2209 (55 yo), 2209 (49 yo), 2209 (78 yo), 2209 (64 yo), 2209 (56 yo), 2209 (45 yo), 2209 (53 yo), 2209 (66 yo), 2209 (41 yo), 2209 (57 yo), 2209 (69 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_018.png
          :alt: 2209 (28 yo), 2209 (66 yo), 2209 (46 yo), 2209 (70 yo), 2209 (45 yo), 2209 (79 yo), 2209 (41 yo), 2209 (71 yo), 2209 (40 yo), 2209 (66 yo), 2209 (43 yo), 2209 (62 yo), 2209 (25 yo), 2209 (28 yo), 2209 (22 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_019.png
          :alt: 2209 (21 yo), 2209 (20 yo), 2209 (23 yo), 2209 (33 yo), 2209 (16 yo), 2209 (17 yo), 2209 (30 yo), 2209 (37 yo), 2209 (17 yo), 2209 (20 yo), 2209 (47 yo), 2209 (30 yo), 2209 (52 yo), 2209 (41 yo), 2209 (40 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_020.png
          :alt: 2209 (29 yo), 2209 (39 yo), 2209 (27 yo), 2209 (31 yo), 2209 (30 yo), 2209 (16 yo), 2209 (20 yo), 2209 (24 yo), 2209 (30 yo), 2209 (18 yo), 2209 (24 yo), 2209 (41 yo), 2209 (21 yo), 2209 (23 yo), 2209 (17 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_021.png
          :alt: 2209 (25 yo), 2209 (41 yo), 2209 (39 yo), 2209 (29 yo), 2209 (22 yo), 2209 (57 yo), 2209 (44 yo), 2209 (31 yo), 2209 (17 yo), 2209 (35 yo), 2209 (17 yo), 2209 (46 yo), 2209 (27 yo), 2209 (20 yo), 2209 (40 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_022.png
          :alt: 2209 (22 yo), 2209 (42 yo), 2209 (20 yo), 2209 (21 yo), 2209 (36 yo), 2209 (35 yo), 2209 (63 yo), 2209 (29 yo), 2209 (25 yo), 2209 (33 yo), 2209 (20 yo), 2209 (19 yo), 2209 (32 yo), 2209 (30 yo), 2209 (16 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_023.png
          :alt: 2209 (28 yo), 2209 (22 yo), 2209 (17 yo), 2209 (26 yo), 2209 (38 yo), 2209 (19 yo), 2209 (16 yo), 2209 (23 yo), 2209 (28 yo), 2209 (51 yo), 2209 (33 yo), 2209 (31 yo), 2209 (36 yo), 2209 (27 yo), 2209 (58 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_024.png
          :alt: 2209 (28 yo), 2209 (32 yo), 2209 (29 yo), 2209 (26 yo), 2209 (30 yo), 2209 (30 yo), 2209 (44 yo), 2209 (23 yo), 2209 (16 yo), 2209 (36 yo), 2209 (36 yo), 2209 (40 yo), 2209 (9 yo), 2209 (13 yo), 2209 (10 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_025.png
          :alt: 2209 (13 yo), 2209 (13 yo), 2209 (12 yo), 2209 (12 yo), 2209 (10 yo), 2209 (10 yo), 2209 (9 yo), 2209 (11 yo), 2209 (11 yo), 2209 (12 yo), 2209 (14 yo), 2209 (14 yo), 2209 (11 yo), 2209 (12 yo), 2209 (15 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_026.png
          :alt: 2209 (12 yo), 2209 (8 yo), 2209 (6 yo), 2209 (14 yo), 2209 (11 yo), 2209 (12 yo), 2209 (12 yo), 2209 (8 yo), 2209 (11 yo), 2209 (10 yo), 2209 (9 yo), 2209 (9 yo), 2209 (6 yo), 2209 (13 yo), 2209 (8 yo)
          :class: sphx-glr-multi-img

    *

      .. image:: /_examples/visualization/images/sphx_glr_plot_mpl_trajectories_027.png
          :alt: 2209 (13 yo)
          :class: sphx-glr-multi-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Adding...                  severe | max
    Adding...                 warning | max
    Adding...                    mild | max

    Dtypes:
    Unnamed: 0                      Int64
    study_no                       string
    date                    datetime64...
    abdominal_pain                boolean
    abdominal_tenderness          boolean
                                ...      
    severe_bleed                  boolean
    severe_organ                  boolean
    severe                        boolean
    warning                       boolean
    mild                          boolean
    Length: 428, dtype: object

    Data Full:
            Unnamed: 0       study_no       date  abdominal_pain  abdominal_tenderness  abscess   age   aids   alt  ...  rur_urb  liver_abnormal  kidney_abnormal  severe_leak  severe_bleed  severe_organ  severe  warning   mild
    409            409  01nva-003-... 2020-07-14           True           False            <NA>  16.0   <NA>  62.0  ...     <NA>          False            <NA>          False         False          True    True     True  False
    410            410  01nva-003-... 2020-07-15           True            <NA>            <NA>  16.0   <NA>  <NA>  ...     <NA>          False            <NA>          False         False         False    True     True  False
    411            411  01nva-003-... 2020-07-16           True            <NA>           False  16.0   <NA>  <NA>  ...     <NA>          False            <NA>          False         False         False    True     True  False
    412            412  01nva-003-... 2020-07-17           True            <NA>            <NA>  16.0   <NA>  <NA>  ...     <NA>          False            <NA>          False         False         False    True     True  False
    415            415  01nva-003-... 2020-07-28           True            True           False  17.0  False  17.0  ...     <NA>          False           False           True         False          True    True     True  False
    ...            ...            ...        ...            ...             ...             ...   ...    ...   ...  ...      ...            ...             ...            ...           ...           ...     ...      ...    ...
    124836       33914         md-994 2003-07-21          False           False            <NA>  13.0   <NA>  <NA>  ...    Urban          False            <NA>          False         False          True    True    False  False
    124846       33924         md-995 2003-07-22          False           False            <NA>   9.0   <NA>  <NA>  ...     <NA>          False            <NA>          False         False          True    True    False  False
    124857       33935         md-996 2003-07-22          False           False            <NA>  10.0   <NA>  <NA>  ...    Urban          False            <NA>          False         False          True    True     True  False
    124877       33955         md-998 2003-07-23          False           False            <NA>  13.0   <NA>  <NA>  ...     <NA>          False            <NA>          False         False          True    True     True  False
    124888       33966         md-999 2003-07-23          False           False            <NA>  15.0   <NA>  <NA>  ...    Urban          False            <NA>          False         False          True    True     True  False

    [19516 rows x 428 columns]

    Data Agg:
                   dsource   age  weight    plt  haematocrit_percent  body_temperature  gender       date  shock  severe  warning   mild
    study_no                                                                                                                            
    01nva-003-2008   01nva  16.0    72.0    8.0           54.0               37.075        1.0 2020-07-17   True    True     True  False
    01nva-003-2009   01nva  17.0    44.0    8.0        47.3333                 37.0        0.0 2020-07-30   True    True     True  False
    01nva-003-2012   01nva  17.0    48.0    9.0          49.15              37.1875        0.0 2020-08-15   True    True     True  False
    01nva-003-2024   01nva  16.0   114.0    9.0           49.1              37.1167        1.0 2020-10-09   True    True     True  False
    01nva-003-2028   01nva  18.0    82.0   18.0        42.9714                37.15        0.0 2020-11-07   True    True     True  False
    ...                ...   ...     ...    ...            ...                  ...        ...        ...    ...     ...      ...    ...
    md-994              md  13.0    53.0   88.0           42.0                 40.0        0.0 2003-08-27  False    True    False   True
    md-995              md   9.0    27.5  132.0           37.8                 39.0        0.0 2003-08-27  False    True    False   True
    md-996              md  10.0    33.0   75.0           43.0                 39.9        0.0 2003-07-24  False    True     True  False
    md-998              md  13.0    44.0   94.0           41.5                 38.5        1.0 2003-08-29  False    True     True  False
    md-999              md  15.0    49.0   56.0           40.5                 38.5        0.0 2003-08-29  False    True     True  False

    [12884 rows x 12 columns]
    severe     5029
    warning    6809
    mild       5609
    dtype: int64

    Data 01NVA:
                   dsource   age  weight   plt  haematocrit_percent  body_temperature  gender       date  shock  severe  warning   mild
    study_no                                                                                                                           
    01nva-003-2008   01nva  16.0    72.0   8.0           54.0               37.075        1.0 2020-07-17   True    True     True  False
    01nva-003-2009   01nva  17.0    44.0   8.0        47.3333                 37.0        0.0 2020-07-30   True    True     True  False
    01nva-003-2012   01nva  17.0    48.0   9.0          49.15              37.1875        0.0 2020-08-15   True    True     True  False
    01nva-003-2024   01nva  16.0   114.0   9.0           49.1              37.1167        1.0 2020-10-09   True    True     True  False
    01nva-003-2028   01nva  18.0    82.0  18.0        42.9714                37.15        0.0 2020-11-07   True    True     True  False
    01nva-003-2033   01nva  17.0    50.0  19.0        46.5333              37.0333        0.0 2021-01-14   True    True     True  False
    01nva-003-2108   01nva  17.0    62.0  12.0           43.0              37.2333        0.0 2020-10-11   True    True     True  False
    01nva-003-2110   01nva  17.0    49.0   8.0           53.4                37.22        1.0 2020-11-08   True    True     True  False
    01nva-003-2168   01nva  16.0    62.0  20.0           42.6              37.0944        0.0 2020-08-16   <NA>    True    False   True
    01nva-003-2171   01nva  17.0    58.0  26.0           45.9               37.225        0.0 2020-08-22   <NA>    True    False   True
    01nva-003-2175   01nva  16.0    61.0  36.5           41.8                37.25        1.0 2020-09-08   <NA>    True     True  False
    01nva-003-2192   01nva  16.0    53.0  29.0           47.1              37.7792        0.0 2020-12-26   <NA>    True    False   True
    01nva-003-2201   01nva   9.0    39.0  33.0           45.6              37.1611        1.0 2020-06-07   True    True     True  False
    01nva-003-2202   01nva  13.0    73.0   6.0        46.2333              37.2875        0.0 2020-06-19   True    True     True  False
    01nva-003-2203   01nva  10.0    23.8  33.0        47.1333              37.2708        0.0 2020-06-19   True    True     True  False
    01nva-003-2204   01nva  13.0    78.0  19.0        46.8333              37.2333        1.0 2020-06-27   True    True     True  False
    01nva-003-2205   01nva  13.0    33.0   9.0           40.9               37.205        0.0 2020-07-05   True    True    False  False
    01nva-003-2206   01nva  12.0    40.0  14.0        46.9429                37.45        1.0 2020-07-11   True    True     True  False
    01nva-003-2208   01nva  12.0    47.0  58.0        52.8667              37.2417        1.0 2020-07-22   True    True     True  False
    01nva-003-2209   01nva  10.0    31.0  30.5           35.3              36.9611        0.0 2020-08-02   True    True     True  False
    01nva-003-2210   01nva  10.0    50.0  11.5          41.86                37.25        1.0 2020-08-06   True    True     True  False
    01nva-003-2211   01nva   9.0    22.0  30.0           51.1               37.075        0.0 2020-08-09   <NA>   False     True  False
    01nva-003-2212   01nva  11.0    47.7  13.5         40.955                 37.3        0.0 2020-08-21   True    True     True  False
    01nva-003-2213   01nva  11.0    56.0  16.0          46.42              37.2542        1.0 2020-08-25   True    True     True  False
    01nva-003-2214   01nva  12.0    30.0  39.0          46.35               37.325        1.0 2020-08-27   True    True     True  False
    01nva-003-2216   01nva  14.0    44.0  22.0           48.2               37.205        0.0 2020-09-11   <NA>    True     True  False
    01nva-003-2217   01nva  14.0    45.0  10.0           42.0                37.33        0.0 2020-09-13   <NA>    True     True  False
    01nva-003-2218   01nva  11.0    28.0  29.0           47.6              37.2556        0.0 2020-09-16   True    True     True  False
    01nva-003-2219   01nva  12.0    38.3  19.0           44.4                 37.2        1.0 2020-09-20   <NA>   False     True  False
    01nva-003-2220   01nva  15.0    66.4  10.0           53.2              37.0833        1.0 2020-09-27   <NA>    True     True   True
    01nva-003-2221   01nva  12.0    43.7  27.0           51.1              37.2833        0.0 2020-09-30   <NA>    True     True  False
    01nva-003-2222   01nva   8.0    40.7  23.0          67.05              37.1733        1.0 2020-10-05   True    True     True  False
    01nva-003-2223   01nva   6.0    20.0  18.0           45.7              37.0875        0.0 2020-10-11   <NA>   False     True  False
    01nva-003-2224   01nva  14.0    83.0  26.0           49.8              37.4167        1.0 2020-10-10   <NA>   False     True   True
    01nva-003-2225   01nva  11.0    48.0  22.0           43.3              37.4083        0.0 2020-10-12   True    True     True  False
    01nva-003-2226   01nva  12.0    25.4  46.0          43.25              37.0833        1.0 2020-10-18   <NA>   False     True  False
    01nva-003-2227   01nva  12.0    45.0  24.0           46.2                 37.4        1.0 2020-10-26   <NA>    True     True  False
    01nva-003-2228   01nva   8.0    32.3  22.0          47.65                 37.3        0.0 2020-10-25   True    True     True  False
    01nva-003-2229   01nva  11.0    38.0  38.0           44.4                37.25        0.0 2020-11-04   <NA>   False     True  False
    01nva-003-2230   01nva  10.0    43.8  24.0           47.0                 37.4        1.0 2020-11-25   <NA>   False     True  False
    01nva-003-2231   01nva   9.0    42.2  21.0           44.9              37.2083        1.0 2020-12-05   <NA>    True     True  False
    01nva-003-2232   01nva   9.0    28.0  18.0           46.7              37.1875        1.0 2020-12-19   True    True     True  False
    01nva-003-2233   01nva   6.0    22.0  37.0           51.3                37.25        1.0 2020-12-30   <NA>    True     True  False
    01nva-003-2234   01nva  13.0    61.0  17.5          52.15               37.375        1.0 2021-01-08   <NA>    True     True  False
    01nva-003-2235   01nva   8.0    21.0  18.0           43.1              37.3333        0.0 2021-01-17   <NA>   False     True  False
    01nva-003-2236   01nva  13.0    34.0  17.5          42.15                 37.5        0.0 2021-01-19   <NA>   False     True  False

    Model:
    Autoencoder(
      (encoder): Sequential(
        (0): Linear(in_features=5, out_features=3, bias=True)
        (1): Sigmoid()
        (2): Linear(in_features=3, out_features=2, bias=True)
        (3): Sigmoid()
      )
      (decoder): Sequential(
        (0): Linear(in_features=2, out_features=3, bias=True)
        (1): Sigmoid()
        (2): Linear(in_features=3, out_features=5, bias=True)
        (3): Sigmoid()
      )
    )

    Scaler:
    MinMaxScaler()

    Data:
                   dsource   age  weight    plt  haematocrit_percent  body_temperature  gender       date  shock  severe  warning   mild       x       y
    study_no                                                                                                                                            
    01nva-003-2008   01nva  16.0    72.0    8.0           54.0               37.075        1.0 2020-07-17   True    True     True  False  0.1512  0.7534
    01nva-003-2009   01nva  17.0    44.0    8.0        47.3333                 37.0        0.0 2020-07-30   True    True     True  False  0.2637  0.7461
    01nva-003-2012   01nva  17.0    48.0    9.0          49.15              37.1875        0.0 2020-08-15   True    True     True  False  0.2355  0.7499
    01nva-003-2024   01nva  16.0   114.0    9.0           49.1              37.1167        1.0 2020-10-09   True    True     True  False  0.0770  0.7300
    01nva-003-2028   01nva  18.0    82.0   18.0        42.9714                37.15        0.0 2020-11-07   True    True     True  False  0.1061  0.7033
    ...                ...   ...     ...    ...            ...                  ...        ...        ...    ...     ...      ...    ...     ...     ...
    md-994              md  13.0    53.0   88.0           42.0                 40.0        0.0 2003-08-27  False    True    False   True  0.2153  0.5973
    md-995              md   9.0    27.5  132.0           37.8                 39.0        0.0 2003-08-27  False    True    False   True  0.4943  0.5385
    md-996              md  10.0    33.0   75.0           43.0                 39.9        0.0 2003-07-24  False    True     True  False  0.4532  0.6385
    md-998              md  13.0    44.0   94.0           41.5                 38.5        1.0 2003-08-29  False    True     True  False  0.2835  0.5919
    md-999              md  15.0    49.0   56.0           40.5                 38.5        0.0 2003-08-29  False    True     True  False  0.2306  0.6417

    [12884 rows x 14 columns]

    Patients:
    151






|

.. code-block:: default
   :lineno-start: 6


    # Library
    import pickle
    import pandas as pd
    import numpy as np
    import matplotlib as mpl

    # Specific
    from torch.utils.data import DataLoader
    from sklearn.preprocessing import MinMaxScaler
    from sklearn.neighbors import KDTree
    from tableone import TableOne

    # Specific
    from pkgname.core.AE.autoencoder import get_device, set_seed
    from pkgname.utils.data_loader import load_dengue, IQR_rule
    from pkgname.utils.plot_utils import  format_table_bootstrap
    from definitions import ROOT_DIR

    # Local
    import _utils



    # ------------------------------
    # Constants
    # ------------------------------
    # Load constants
    features = _utils.features
    others = _utils.others
    mappings = _utils.mappings
    aggregation = _utils.aggregation
    cmaps = _utils.cmaps

    # Define outcomes
    outcomes = [
        "severe",
        "warning",
        "mild"]

    # Ensure all outcomes are in aggregation
    for c in outcomes:
        if c not in aggregation:
            print("Adding... %23s | max" % c)
            aggregation[c] = 'max'

    # ------------------------------
    # Load data
    # ------------------------------
    # Load data
    data = _utils.load_data()

    # Liver abnormal
    data['liver_abnormal'] = \
        data.liver_acute | \
        data.liver_involved | \
        data.liver_failure | \
        data.liver_severe | \
        data.jaundice

    # Kidney abnormal
    data['kidney_abnormal'] = \
        data.skidney

    # Create features
    data['severe_leak'] = \
        data.ascites | \
        data.overload | \
        data.oedema_pulmonary | \
        data.respiratory_distress | \
        data.oedema | \
        data.pleural_effusion | \
        data.effusion

    # Bleeding
    data['severe_bleed'] = \
        data.bleeding_gi | \
        data.bleeding_urine | \
        data.bleeding_mucosal

    # Organ impairment
    data['severe_organ'] = \
        data.cns_abnormal | \
        data.neurology.astype(bool) | \
        data.liver_abnormal | \
        data.kidney_abnormal | \
        (data.ast.fillna(0) >= 1000) | \
        (data.alt.fillna(0) >= 1000)

    # Category: severe
    data['severe'] = \
        data.severe_leak | \
        data.severe_bleed | \
        data.severe_organ | \
        data.shock

    # Category: warning WHO
    data['warning'] = \
        data.abdominal_pain | \
        data.abdominal_tenderness | \
        data.vomiting | \
        data.ascites | \
        data.pleural_effusion | \
        data.bleeding_mucosal | \
        data.restlessness | \
        data.lethargy | \
        (data.liver_palpation_size.fillna(0) > 2)

    # Category: mild
    data['mild'] = ~(data.severe | data.warning)

    # Fill empty values (be careful!)
    for c in outcomes:
        data[c] = data[c].fillna(0)

    # Raw after very basic cleaning
    raw = data.copy(deep=True)

    # Filter data (age, iqr, ...)
    # .. note: Although previously we were filtering only
    #          for adults, there is an interesting patient
    #          (01nva-003-2164) who is 19 years old.
    #
    # .. note: Platelets has a very clear outlier 50000
    #          which influences the quartile selection
    #          in the quartile range rule (IQR)
    data = data[data.age.between(0.0, 18.0)]
    data = data[data.plt < 50000] # extreme outlier

    # Filter outliers
    data = IQR_rule(data, [
        'plt',
        #'haematocrit_percent',
        #'body_temperature'
    ])

    # Convert dtypes
    data = data.convert_dtypes()

    # Rename
    # .. note: Done after convert_dtypes so that
    #          it remains 0 or 1, otherwise it will
    #          be transformed to boolean feature.
    #          (its ok too).
    data = data.replace(mappings)

    # Show dtypes
    print("\nDtypes:")
    print(data.dtypes)

    # ------------------------------
    # Aggregate to worse combo
    # ------------------------------
    # Get worst state for patient
    data_w = data.copy(deep=True) \
        .groupby(by="study_no", dropna=False) \
        .agg(aggregation) \
        .dropna(how='any', subset=features)

    # Get full data
    data_f = data.copy(deep=True) \
        .dropna(how='any', subset=features)

    # Show data
    print("\nData Full:")
    print(data_f)
    print("\nData Agg:")
    print(data_w)
    print(data_w[outcomes].sum())
    print("\nData 01NVA:")
    print(data_w[data_w.dsource == '01nva'])

    # ------------------------------
    # Load Model
    # ------------------------------
    # Load model
    model = _utils.load_model()

    # Show
    print("\nModel:")
    print(model)

    # ------------------------------
    # Projections
    # ------------------------------
    # .. note: The scaling method should have also
    #          been saved when training the model.
    # Scaler
    scaler = MinMaxScaler().fit(data_f[features])

    # Include encoded in aggregated
    data_w[['x', 'y']] = model.encode_inputs( \
        DataLoader(scaler.transform(data_w[features]),
             16, shuffle=False))

    # Include encoded in full (filtered)
    data_f[['x', 'y']] = model.encode_inputs( \
        DataLoader(scaler.transform(data_f[features]),
             16, shuffle=False))

    # Show
    print("\nScaler:")
    print(scaler)
    print("\nData:")
    print(data_w)


    # ------------------------------
    # Visualization
    # ------------------------------
    # Libraries
    import matplotlib.pyplot as plt

    # Specific
    from _utils import kde_mpl_plot
    from _utils import kde_mpl_compute
    from _utils import kde_mpl

    # ------------------------------------
    # Show interesting outcomes (contours)
    # ------------------------------------
    # Figure with kdes
    f1, axes1 = plt.subplots(1, 3,
        figsize=(15, 4), sharex=True, sharey=True)

    # Loop
    for i, c in enumerate(outcomes):
        # Select dataset
        aux = data_w[data_w[c] == 1]
        # Plot kde
        kde_mpl(aux.x, aux.y, ax=axes1.flat[i],
            contour=True, cmap=cmaps.get(c, 'Reds'),
            xlim=(data_w.x.min(), data_w.x.max()),
            ylim=(data_w.y.min(), data_w.y.max()))
        # Configure
        axes1.flat[i].set(aspect='equal',
            title='%s (%s)' % (c.title(), aux.shape[0]))

    # Plot aggregated (data_w)
    aux = data_w[data_w.dsource == '01nva']
    axes1.flat[0].scatter(aux.x, aux.y,
        s=4, linewidth=0.5,
        c=aux.shock \
            .replace({0:'k', 1:'r'}) \
            .fillna('k'))

    # Plot daily (data_f)
    aux = data_f[data_f.dsource == '01nva']
    axes1.flat[1].scatter(aux.x, aux.y,
        s=4, linewidth=0.5,
        c=aux.event_shock \
            .replace({0:'k', 1:'r'}) \
            .fillna('k'))

    # Order by study_no and day_from_admission
    aux = aux.sort_values( \
        by=['study_no', 'day_from_admission'])

    # Plot trajectories
    for i,g in aux.groupby('study_no'):
        axes1.flat[2].plot(g.x, g.y, c='k',
           marker='o', markersize=2, linewidth=0.5)
        for i,j,v in zip(g.x, g.y, g.day_from_admission):
            axes1.flat[2].annotate(str(v), xy=(i, j))

    # Configure
    plt.tight_layout()



    # -------------------------------------
    # Individual trajectories
    # -------------------------------------
    # .. note: Note that the scaling method before considers
    #          only patients under 18. Thus, wen testing patients
    #          over 18 they are pushed to the right hand side.
    #          Thus, we are min max scaling with all ages although
    #          this is not ideal if algorithm was trained with <18.
    # Scaler
    scaler = MinMaxScaler().fit(data_f[features])
    #scaler = MinMaxScaler().fit(raw[features])

    # Convert dtypes
    data = data.convert_dtypes()
    # Select all 01nva data and clean
    data = raw[raw.dsource == '01nva'] \
        .copy(deep=True) \
        .dropna(how='any', subset=features) \
        .sort_values(by=['study_no',
                         'day_from_admission'])

    # Include encoded in full (filtered)
    data[['x', 'y']] = model.encode_inputs( \
        DataLoader(scaler.transform(data[features]),
             16, shuffle=False))

    # Compute KDE (children)
    aux = data_w[data_w.severe == 1]
    xgrid, ygrid, Zgrid = kde_mpl_compute(aux.x, aux.y,
        xlim=(data_w.x.min(), data_w.x.max()),
        ylim=(data_w.y.min(), data_w.y.max()))

    """
    # Compute KD2 (all)
    # Get worst state for patient
    scl = MinMaxScaler().fit(raw[features])
    aux = raw.copy(deep=True)
    aux_w = aux.copy(deep=True) \
        .groupby(by="study_no", dropna=False) \
        .agg(aggregation) \
        .dropna(how='any', subset=features)
    # Include encoded in full (filtered)
    aux_w[['x', 'y']] = model.encode_inputs( \
        DataLoader(scl.transform(aux_w[features]),
             16, shuffle=False))
    aux = aux_w[aux_w.severe == 1]
    xgrid, ygrid, Zgrid = kde_mpl_compute(aux.x, aux.y,
        xlim=(aux_w.x.min(), aux_w.x.max()),
        ylim=(aux_w.y.min(), aux_w.y.max()))
    """
    # Show
    print("\nPatients:")
    print(data.study_no.nunique())

    # -------------------------
    # Plot interesting patients
    # -------------------------
    # Lets define the patients
    patients = [
        1105,
        2012, # 2 shocks
        2013,
        2026, # 3 shocks
        2103, # 2 shocks
        2104,
        2110,
        2168,
        2203,
        2205,
        2206,
        2205,
        2217,
        2222,
        2207, # 3 shocks
        2209, # 2 shocks
    ]

    # Plot graph for each patient
    for p in patients:
        # Get data
        aux = data[data.study_no.str.endswith(str(p))]

        if aux.shape[0] == 0:
            continue

        # Create figure
        f, ax = plt.subplots(1, 1)

        # Plot KDE (data aggregated)
        kde_mpl_plot(xgrid, ygrid, Zgrid, ax=ax,
            contour=True, cbar=False, cmap='Reds')

        # Plot evolution (line + markers)
        ax.plot(aux.x, aux.y, c='k', label=p, alpha=0.75,
            marker='o', markersize=5, linewidth=0.5)
        ax.set(title='Patient %s (%s years)' % \
            (str(p), int(aux.age.values[0])), aspect='equal')

        # Plot numbers
        for i,j,v in zip(aux.x, aux.y, aux.day_from_admission):
            ax.annotate(str(int(v)), xy=(i+0.01, j))

        # Plot shock
        if aux.event_shock.any():
            ax.scatter(
                aux[aux.event_shock.fillna(False)].x,
                aux[aux.event_shock.fillna(False)].y,
                marker='o', color='red', edgecolor='k',
                s=10, linewidth=0.5, zorder=10)

        # Hide the right and top spines
        ax.spines.right.set_visible(False)
        ax.spines.top.set_visible(False)

        plt.tight_layout()

        # Show
        #print(aux[features + others + ['shock', 'event_shock']])


    # -------------------------
    # Plot ALL patients
    # -------------------------
    # Filter more than length n
    v = data.study_no.value_counts()
    aux = data[data.study_no.isin(v.index[v.gt(0)])]

    # Create groups
    groups = aux.groupby('study_no')

    # For each patient
    for c, (n,g) in enumerate(groups):

        if c % 15 == 0:
            # Tight previous figure
            plt.tight_layout()
            # Create figure
            f2, axes2 = plt.subplots(3, 5,
                figsize=(15, 9), sharex=True, sharey=True)

        #if c > len(axes2.flat) - 1:
        #    break
        # Get axes
        ax = axes2.flat[c % 15]

        # Plot KDE (data aggregated)
        kde_mpl_plot(xgrid, ygrid, Zgrid, ax=ax,
                contour=True, cbar=False, cmap='Reds')

        # Plot line and markers
        ax.plot(g.x, g.y, c='k', label=n,
            marker='o', markersize=3, linewidth=0.5)
        ax.set(title=n.split('-')[-1], aspect='equal')
        ax.set(title='%s (%s yo)' % \
            (str(p), int(g.age.values[0])), aspect='equal')

        # Highlight shocks
        if g.event_shock.any():
            ax.scatter(
                g[g.event_shock.fillna(False)].x,
                g[g.event_shock.fillna(False)].y,
                marker='o', color='red', edgecolor='k',
                s=10, linewidth=0.5, zorder=10)

        # Plot numbers
        for i,j,v in zip(g.x, g.y, g.day_from_admission):
            ax.annotate(str(int(v)), xy=(i+0.05, j))
        # Show legend
        #ax.legend(loc="lower right")
        # Hide the right and top spines
        ax.spines.right.set_visible(False)
        ax.spines.top.set_visible(False)



    # Configure
    plt.tight_layout()

    # Show
    plt.show()

.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  27.816 seconds)


.. _sphx_glr_download__examples_visualization_plot_mpl_trajectories.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_mpl_trajectories.py <plot_mpl_trajectories.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_mpl_trajectories.ipynb <plot_mpl_trajectories.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
